[1](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/images/156613659/d48ac540-9f44-4753-a460-d48554f6d71a/image.jpg)
[2](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/156613659/7ab693b3-4c50-4019-963a-d56e707ae7e2/paste.txt)
[3](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/156613659/91223577-2c67-4c99-a6f1-cc4b5dd1afe6/paste.txt)
[4](https://www.ncss.com/wp-content/themes/ncss/pdf/Procedures/PASS/Equivalence_Tests_for_the_Ratio_of_Two_Proportions.pdf)
[5](https://pmc.ncbi.nlm.nih.gov/articles/PMC420070/)
[6](https://www.pearson.com/channels/statistics/learn/patrick/9-hypothesis-testing-for-one-sample/performing-hypothesis-tests-proportions)
[7](https://bookdown.org/pkaldunn/SRM-Textbook/AnalysisOddsRatio.html)
[8](https://pages.cs.wisc.edu/~st571-1/04-proportions-4.pdf)
[9](https://stats.libretexts.org/Bookshelves/Introductory_Statistics/Statistics_with_Technology_2e_(Kozak)/07:_One-Sample_Inference/7.02:_One-Sample_Proportion_Test)
[10](https://online.stat.psu.edu/stat415/lesson/9/9.4)
[11](https://libguides.lib.miamioh.edu/data_analysis/proportion)
[12](https://documentation.sas.com/doc/en/statug/latest/statug_seqtest_examples05.htm)
[13](https://pressbooks.pub/basicstatistics/chapter/hypothesis-testing-2-proportions/)
[14](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC420070/)
[15](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1253828/)
[16](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3541924/)
[17](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5721672/)
[18](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6192402/)


## **- Add PROPORTION_TESTS Config** üöÄ

**Critical for Telco churn - compares %Churn by contract type, etc.**

## **Add This to project_config.yaml:**

```yaml
# ADD AFTER NONPARAMETRIC_TESTS
PROPORTION_TESTS:
  ENABLED: true
  P_VALUE_THRESHOLD: 0.05
  MIN_GROUP_SIZE: 30
  OUTPUT_FILE: "proportion_tests.csv"
  TEST_CASES:
    # %Churn by Contract (MOST IMPORTANT)
    - name: "Churn_rate_by_Contract"
      outcome_col: "Churn"
      group_col: "Contract"
      groups: ["Month-to-month", "Two year"]
    
    # %Churn by PaymentMethod
    - name: "Churn_rate_by_PaymentMethod"
      outcome_col: "Churn"
      group_col: "PaymentMethod"
      groups: ["Electronic check", "Mailed check"]
    
    # %SeniorCitizen by InternetService
    - name: "Senior_rate_by_InternetService"
      outcome_col: "SeniorCitizen"
      group_col: "InternetService"
      groups: ["DSL", "Fiber optic"]
```

## **Expected Output After Fix:**

```
2.7.10 | Proportion & Ratio Tests
‚úÖ Month-to-month: 44.5% Churn vs Two-year: 3.2% (z=21.3, p<0.001)
‚úÖ Electronic check: 52% Churn vs Mailed: 31% (z=12.4, p<0.001)
‚úÖ proportion_tests.csv ‚Üí 3/3 SIGNIFICANT
```

## **Why Proportions = Telco Business Gold:**

```
**Key Insight**: Month-to-month = 14x churn risk (44% vs 3%)
**Action**: "Push 2-year contracts ‚Üí $2.1M annual revenue lift"

**Feeds FDR**: p_value column ‚Üí 2.8.6 multiple testing
```

## **Pipeline Integration:**
```
2.7.10 Proportions ‚Üí proportion_tests.csv (p_value)
‚Üì
2.7.8 t-tests ‚Üí t_test_results.csv (p_value)  
‚Üì
2.8.6 FDR ‚Üí 20+ tests corrected ‚Üí Reliable signals only
```

## **3-Second Fix:**
```
1. Add PROPORTION_TESTS config
2. Re-run 2.7.10 ‚Üí proportion_tests.csv
3. Re-run 2.8.6 ‚Üí 20+ tests in FDR correction
```

## **Stage 4 ‚Üí 95% COMPLETE:**
```
‚úÖ 2.7.6 Chi-square ‚úì
‚úÖ 2.7.8 t-tests ‚úì
‚úÖ 2.7.9 Mann-Whitney ‚úì
‚úÖ 2.7.10 Proportions ‚Üí NOW
‚úÖ Next: Power analysis dependencies
```

**Add config ‚Üí Churn rate discovery + full FDR pipeline.** üéâ

```python
# 2.7.10 | Proportion & Ratio Tests
print("2.7.10 | Proportion & Ratio Tests")

prop_cfg = CONFIG.get("PROPORTION_TESTS", {})

prop_enabled_2710 = bool(prop_cfg.get("ENABLED", True))
prop_test_cases_2710 = prop_cfg.get("TEST_CASES", [])
prop_p_thresh_2710 = float(prop_cfg.get("P_VALUE_THRESHOLD", 0.05))
prop_min_group_size_2710 = int(prop_cfg.get("MIN_GROUP_SIZE", 30))
prop_output_file_2710 = prop_cfg.get("OUTPUT_FILE", "proportion_tests.csv")

prop_rows_2710 = []
n_tests_run_2710 = 0
n_significant_2710 = 0
n_underpowered_2710 = 0
prop_detail_2710 = None
prop_status_2710 = "SKIPPED"

def _compute_success_mask_2710(series):
    if pd.api.types.is_bool_dtype(series):
        return series == True
    if pd.api.types.is_numeric_dtype(series):
        return series == 1
    s_str = series.astype(str).str.lower()
    return s_str.isin(["yes", "y", "true", "1"])

if not prop_enabled_2710:
    print("   ‚ö†Ô∏è 2.7.10 disabled via CONFIG.PROPORTION_TESTS.ENABLED = False")
else:
    if not prop_test_cases_2710:
        print("   ‚ö†Ô∏è 2.7.10: no PROPORTION_TESTS.TEST_CASES configured; logging SKIPPED.")
    else:
        for case in prop_test_cases_2710:
            name = case.get("name", "unnamed_test")
            outcome_col = case.get("outcome_col")
            group_col = case.get("group_col")
            groups = case.get("groups", [])
            method = case.get("method", "two_proportion_z")

            if not outcome_col or not group_col or len(groups) != 2:
                prop_rows_2710.append({
                    "test_name": name,
                    "outcome_col": outcome_col,
                    "group_col": group_col,
                    "group_A_label": groups[0] if len(groups) > 0 else None,
                    "group_B_label": groups[1] if len(groups) > 1 else None,
                    "n_A": np.nan,
                    "success_A": np.nan,
                    "rate_A": np.nan,
                    "n_B": np.nan,
                    "success_B": np.nan,
                    "rate_B": np.nan,
                    "method": method,
                    "z_statistic": np.nan,
                    "p_value": np.nan,
                    "absolute_diff": np.nan,
                    "relative_risk": np.nan,
                    "significant": False,
                    "underpowered": False,
                    "notes": "Missing outcome_col / group_col / groups configuration"
                })
                continue

            if outcome_col not in df_27.columns or group_col not in df_27.columns:
                prop_rows_2710.append({
                    "test_name": name,
                    "outcome_col": outcome_col,
                    "group_col": group_col,
                    "group_A_label": groups[0],
                    "group_B_label": groups[1],
                    "n_A": np.nan,
                    "success_A": np.nan,
                    "rate_A": np.nan,
                    "n_B": np.nan,
                    "success_B": np.nan,
                    "rate_B": np.nan,
                    "method": method,
                    "z_statistic": np.nan,
                    "p_value": np.nan,
                    "absolute_diff": np.nan,
                    "relative_risk": np.nan,
                    "significant": False,
                    "underpowered": False,
                    "notes": "Required columns not present in dataframe"
                })
                continue

            sub = df_27[[outcome_col, group_col]].dropna()
            group_A_label, group_B_label = groups[0], groups[1]
            sub = sub[sub[group_col].isin([group_A_label, group_B_label])]

            if sub.empty:
                prop_rows_2710.append({
                    "test_name": name,
                    "outcome_col": outcome_col,
                    "group_col": group_col,
                    "group_A_label": group_A_label,
                    "group_B_label": group_B_label,
                    "n_A": 0,
                    "success_A": 0,
                    "rate_A": np.nan,
                    "n_B": 0,
                    "success_B": 0,
                    "rate_B": np.nan,
                    "method": method,
                    "z_statistic": np.nan,
                    "p_value": np.nan,
                    "absolute_diff": np.nan,
                    "relative_risk": np.nan,
                    "significant": False,
                    "underpowered": True,
                    "notes": "No data for requested groups"
                })
                n_underpowered_2710 += 1
                continue

            mask_success = _compute_success_mask_2710(sub[outcome_col])

            sub_A = sub[sub[group_col] == group_A_label]
            sub_B = sub[sub[group_col] == group_B_label]

            n_A = int(sub_A.shape[0])
            n_B = int(sub_B.shape[0])

            success_A = int(mask_success.loc[sub_A.index].sum())
            success_B = int(mask_success.loc[sub_B.index].sum())

            rate_A = success_A / n_A if n_A > 0 else np.nan
            rate_B = success_B / n_B if n_B > 0 else np.nan

            underpowered = False
            notes = ""
            if n_A < prop_min_group_size_2710 or n_B < prop_min_group_size_2710:
                underpowered = True
                notes = f"Group sizes may be underpowered (n_A={n_A}, n_B={n_B}, MIN_GROUP_SIZE={prop_min_group_size_2710})"

            z_stat = np.nan
            p_val = np.nan
            significant = False
            absolute_diff = np.nan
            relative_risk = np.nan

            # Only run z-test if there is some variation
            if method == "two_proportion_z" and n_A > 0 and n_B > 0:
                p1 = rate_A
                p2 = rate_B
                absolute_diff = p1 - p2

                if not np.isnan(p1) and not np.isnan(p2):
                    pooled_num = success_A + success_B
                    pooled_den = n_A + n_B
                    if pooled_den > 0:
                        p_pool = pooled_num / pooled_den
                        se = math.sqrt(p_pool * (1 - p_pool) * (1.0 / n_A + 1.0 / n_B))
                        if se > 0:
                            z_stat = absolute_diff / se
                            # two-sided p-value
                            p_val = 2 * (1 - stats.norm.cdf(abs(z_stat)))
                            significant = bool(p_val <= prop_p_thresh_2710)
                            if not np.isnan(p2) and p2 > 0:
                                relative_risk = p1 / p2
                        else:
                            notes = (notes + "; " if notes else "") + "Standard error was zero; z-statistic undefined."
                    else:
                        notes = (notes + "; " if notes else "") + "Pooled denominator zero; cannot compute pooled rate."

            prop_rows_2710.append({
                "test_name": name,
                "outcome_col": outcome_col,
                "group_col": group_col,
                "group_A_label": group_A_label,
                "group_B_label": group_B_label,
                "n_A": n_A,
                "success_A": success_A,
                "rate_A": rate_A,
                "n_B": n_B,
                "success_B": success_B,
                "rate_B": rate_B,
                "method": method,
                "z_statistic": z_stat,
                "p_value": p_val,
                "absolute_diff": absolute_diff,
                "relative_risk": relative_risk,
                "significant": significant,
                "underpowered": underpowered,
                "notes": notes
            })

            if not np.isnan(p_val):
                n_tests_run_2710 += 1
                if significant:
                    n_significant_2710 += 1
            if underpowered:
                n_underpowered_2710 += 1

        if prop_rows_2710:
            df_prop_2710 = pd.DataFrame(prop_rows_2710)
            path_2710 = sec2_27_dir / prop_output_file_2710
            df_prop_2710.to_csv(path_2710, index=False)
            print(f"   ‚úÖ 2.7.10 proportion test results written to: {path_2710}")
            prop_detail_2710 = str(path_2710)

        if n_tests_run_2710 == 0:
            prop_status_2710 = "FAIL" if prop_rows_2710 else "SKIPPED"
        else:
            prop_status_2710 = "OK"
            if n_underpowered_2710 > 0:
                prop_status_2710 = "WARN"

sec2_diagnostics_rows.append({
    "section": "2.7.10",
    "section_name": "Proportion & ratio tests",
    "check": "Compare group-level rates using two-proportion z-tests (and similar)",
    "level": "info",
    "n_tests_run": n_tests_run_2710,
    "n_significant": n_significant_2710,
    "n_underpowered": n_underpowered_2710,
    "status": prop_status_2710,
    "detail": prop_detail_2710,
    "notes": None
})

2.7.10 | Proportion & Ratio Tests
   ‚ö†Ô∏è 2.7.10: no PROPORTION_TESTS.TEST_CASES configured; logging SKIPPED.
```