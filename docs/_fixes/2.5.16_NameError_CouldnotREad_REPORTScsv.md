># Q: WHy is this just now happening? whats the best way to fix it?

```python
# PART E | 2.5.16‚Äì2.5.17 | üé® Visual & Integrity Index Layer
print("\n2.5.E üé® PART E ‚Äì Visual & Integrity Index layer")

# Assumes:
#   - Section 2 artifact dirs already wired by 2.0.x / earlier 2.5.x cells
#   - pandas as pd, os, Path imported
#   - CONFIG and/or C() available (for INTEGRITY_INDEX config)
#   - SECTION2_REPORT_PATH consistent with other 2.x checks

# 2.5.16 | Logic Consistency Dashboard
print("\n2.5.16 üé® Logic consistency dashboard")

# Optional: pull INTEGRITY_INDEX config for display
integrity_cfg_2516 = {}
if "C" in globals() and callable(C):
    try:
        integrity_cfg_2516 = C("INTEGRITY_INDEX", {})
    except Exception:
        integrity_cfg_2516 = {}

if not isinstance(integrity_cfg_2516, dict):
    integrity_cfg_2516 = {}

integrity_weights_2516 = integrity_cfg_2516.get("WEIGHTS", {})
contract_penalties_cfg_2516 = integrity_cfg_2516.get("CONTRACT_PENALTIES", {})

# -------------------------------------------------------------------------
# 2) Try to load core artifacts (all optional, fail-soft)
# -------------------------------------------------------------------------
section2_summary_2516 = None
model_readiness_2516 = None
logic_readiness_2516 = None
data_contract_summary_2516 = None
integrity_index_2516 = None
numeric_drift_2516 = None
rare_cat_2516 = None

# Model readiness (2.4.13)
try:
    _mr_path_2516 = section2_reports_dir_2516 / "model_readiness_report.csv"
    if _mr_path_2516.exists():
        model_readiness_2516 = pd.read_csv(_mr_path_2516)
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not read model_readiness_report.csv: {e}")

# Logic readiness (2.5.12)
try:
    _lr_path_2516 = section2_reports_dir_2516 / "logic_readiness_report.csv"
    if _lr_path_2516.exists():
        logic_readiness_2516 = pd.read_csv(_lr_path_2516)
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not read logic_readiness_report.csv: {e}")

# Data contract summary (2.5.13)
try:
    _dcs_path_2516 = section2_reports_dir_2516 / "data_contract_summary.json"
    if _dcs_path_2516.exists():
        with open(_dcs_path_2516, "r") as f:
            data_contract_summary_2516 = json.load(f)
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not read data_contract_summary.json: {e}")

# Data integrity index (2.5.17) ‚Äì may not exist on first runs
try:
    _di_path_2516 = section2_reports_dir_2516 / "data_integrity_index.csv"
    if _di_path_2516.exists():
        _di_df_2516 = pd.read_csv(_di_path_2516)
        if not _di_df_2516.empty and "integrity_index" in _di_df_2516.columns:
            integrity_index_2516 = float(_di_df_2516.tail(1)["integrity_index"].iloc[0])
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not read data_integrity_index.csv: {e}")

# Integrity history (for trend panel)
integrity_history_2516 = None
try:
    _di_path_full_2516 = section2_reports_dir_2516 / "data_integrity_index.csv"
    if _di_path_full_2516.exists():
        integrity_history_2516 = pd.read_csv(_di_path_full_2516)
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not read full integrity history: {e}")


# Numeric drift (optional, 2.3.x)
try:
    _nd_path_2516 = section2_reports_dir_2516 / "data_drift_metrics.csv"
    if _nd_path_2516.exists():
        numeric_drift_2516 = pd.read_csv(_nd_path_2516)
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not read data_drift_metrics.csv: {e}")

# Rare categories (2.4.x)
try:
    _rc_path_2516 = section2_reports_dir_2516 / "rare_category_report.csv"
    if _rc_path_2516.exists():
        rare_cat_2516 = pd.read_csv(_rc_path_2516)
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not read rare_category_report.csv: {e}")

# -------------------------------------------------------------------------
# 3) Derive a few simple KPIs for the dashboard header
# -------------------------------------------------------------------------
overall_contract_status_2516 = None
if isinstance(data_contract_summary_2516, dict):
    overall_contract_status_2516 = data_contract_summary_2516.get("overall_status")

pct_features_high_readiness_2516 = None
pct_features_high_logic_2516 = None
pct_features_low_readiness_2516 = None

if model_readiness_2516 is not None and "readiness_label" in model_readiness_2516.columns:
    _total_feats_2516 = len(model_readiness_2516)
    if _total_feats_2516 > 0:
        _high_mask_2516 = model_readiness_2516["readiness_label"].astype(str).str.lower() == "high"
        _low_mask_2516 = model_readiness_2516["readiness_label"].astype(str).str.lower() == "low"
        pct_features_high_readiness_2516 = 100.0 * _high_mask_2516.sum() / _total_feats_2516
        pct_features_low_readiness_2516 = 100.0 * _low_mask_2516.sum() / _total_feats_2516

if logic_readiness_2516 is not None and "logic_readiness_label" in logic_readiness_2516.columns:
    _total_logic_feats_2516 = len(logic_readiness_2516)
    if _total_logic_feats_2516 > 0:
        _high_logic_mask_2516 = logic_readiness_2516["logic_readiness_label"].astype(str).str.lower() == "high"
        pct_features_high_logic_2516 = 100.0 * _high_logic_mask_2516.sum() / _total_logic_feats_2516

# Rows logic clean from Section 2 summary row 2.5.12 (if present)
pct_rows_logic_clean_2516 = None
if section2_summary_2516 is not None and "section" in section2_summary_2516.columns:
    _row_2516 = section2_summary_2516.loc[section2_summary_2516["section"] == "2.5.12"]
    if not _row_2516.empty:
        for _cand in ["pct_rows_logic_clean", "pct_rows_logic_ready"]:
            if _cand in _row_2516.columns:
                try:
                    pct_rows_logic_clean_2516 = float(_row_2516[_cand].iloc[0])
                except Exception:
                    pct_rows_logic_clean_2516 = None
                break

# Numeric drift count
n_drifted_features_2516 = None
if numeric_drift_2516 is not None:
    for _cand in ["is_drift", "drift_flag", "drifted"]:
        if _cand in numeric_drift_2516.columns:
            _mask_drift_2516 = numeric_drift_2516[_cand].astype(str).str.lower().isin(["1", "true", "yes", "drift"])
            n_drifted_features_2516 = int(_mask_drift_2516.sum())
            break

# Rare category count
n_rare_categories_2516 = None
if rare_cat_2516 is not None:
    n_rare_categories_2516 = int(len(rare_cat_2516))

# 4) Build HTML fragments


html_parts_2516 = []

_now_iso_2516 = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

# HTML header
html_parts_2516.append("""
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Section 2 Logic Consistency Dashboard</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 20px; }
  h1, h2, h3 { color: #1f2933; }
  .kpi-row { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; }
  .kpi-card {
      border-radius: 10px;
      padding: 12px 16px;
      min-width: 180px;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
  }
  .kpi-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; margin-bottom: 4px; }
  .kpi-value { font-size: 20px; font-weight: 700; color: #111827; }
  .kpi-sub { font-size: 11px; color: #6b7280; }
  .section-block { margin-bottom: 32px; }
  table { border-collapse: collapse; font-size: 12px; }
  th, td { padding: 4px 8px; border: 1px solid #e5e7eb; }
  th { background: #f3f4f6; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; }
  .badge-ok { background: #dcfce7; color: #166534; }
  .badge-warn { background: #fef9c3; color: #854d0e; }
  .badge-fail { background: #fee2e2; color: #991b1b; }
</style>
</head>
<body>
""")

html_parts_2516.append(f"""
<h1>Section 2 ‚Äì Logic Consistency Dashboard</h1>
<p style="color:#4b5563;font-size:12px;">Generated at {_now_iso_2516}</p>
""")

# KPI cards row
html_parts_2516.append('<div class="kpi-row">')

# Integrity index
_kpi_val = f"{integrity_index_2516:.1f}" if integrity_index_2516 is not None else "‚Äî"
html_parts_2516.append(f"""
  <div class="kpi-card">
    <div class="kpi-label">Section 2 Integrity Index</div>
    <div class="kpi-value">{_kpi_val}</div>
    <div class="kpi-sub">0‚Äì100 composite data health score</div>
  </div>
""")

# Contract status
_contract_badge_class = "badge-ok"
_contract_text = str(overall_contract_status_2516 or "N/A")
if isinstance(overall_contract_status_2516, str):
    _st = overall_contract_status_2516.upper()
    if _st == "WARN":
        _contract_badge_class = "badge-warn"
    elif _st == "FAIL":
        _contract_badge_class = "badge-fail"

html_parts_2516.append(f"""
  <div class="kpi-card">
    <div class="kpi-label">Data contract status</div>
    <div class="kpi-value">
      <span class="badge {_contract_badge_class}">{_contract_text}</span>
    </div>
    <div class="kpi-sub">From data_contract_summary.json</div>
  </div>
""")

# % features high model readiness
_kpi_val = f"{pct_features_high_readiness_2516:.1f}%" if pct_features_high_readiness_2516 is not None else "‚Äî"
html_parts_2516.append(f"""
  <div class="kpi-card">
    <div class="kpi-label">Features high model readiness</div>
    <div class="kpi-value">{_kpi_val}</div>
    <div class="kpi-sub">From model_readiness_report.csv</div>
  </div>
""")

# % features high logic readiness
_kpi_val = f"{pct_features_high_logic_2516:.1f}%" if pct_features_high_logic_2516 is not None else "‚Äî"
html_parts_2516.append(f"""
  <div class="kpi-card">
    <div class="kpi-label">Features high logic readiness</div>
    <div class="kpi-value">{_kpi_val}</div>
    <div class="kpi-sub">From logic_readiness_report.csv</div>
  </div>
""")

# % rows logic-clean
_kpi_val = None
if pct_rows_logic_clean_2516 is not None:
    # assume already a fraction 0‚Äì1 or percentage; normalize lightly
    _val = pct_rows_logic_clean_2516
    if _val <= 1.0:
        _val *= 100.0
    _kpi_val = f"{_val:.1f}%"
else:
    _kpi_val = "‚Äî"

html_parts_2516.append(f"""
  <div class="kpi-card">
    <div class="kpi-label">Rows logic-clean</div>
    <div class="kpi-value">{_kpi_val}</div>
    <div class="kpi-sub">From Section 2 summary row 2.5.12</div>
  </div>
""")

# Numeric drift + rare categories
_kpi_nd = f"{n_drifted_features_2516}" if n_drifted_features_2516 is not None else "‚Äî"
_kpi_rc = f"{n_rare_categories_2516}" if n_rare_categories_2516 is not None else "‚Äî"

html_parts_2516.append(f"""
  <div class="kpi-card">
    <div class="kpi-label">Numeric features with drift</div>
    <div class="kpi-value">{_kpi_nd}</div>
    <div class="kpi-sub">From data_drift_metrics.csv (if available)</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Rare categories detected</div>
    <div class="kpi-value">{_kpi_rc}</div>
    <div class="kpi-sub">From rare_category_report.csv</div>
  </div>
""")

html_parts_2516.append("</div>")  # end KPI row

# -------------------------------------------------------------------------
# 5A) Artifact coverage summary
# -------------------------------------------------------------------------
artifact_status_rows_2516 = []

def _add_artifact_row_2516(name, path_obj, loaded_flag):
    artifact_status_rows_2516.append(
        {
            "artifact_name": name,
            "path": str(path_obj),
            "exists_on_disk": bool(path_obj.exists()),
            "loaded_in_dashboard": bool(loaded_flag),
        }
    )

_add_artifact_row_2516("section2_summary.csv", _sec2_summary_path_2516, section2_summary_2516 is not None)
_add_artifact_row_2516("model_readiness_report.csv", section2_reports_dir_2516 / "model_readiness_report.csv", model_readiness_2516 is not None)
_add_artifact_row_2516("logic_readiness_report.csv", section2_reports_dir_2516 / "logic_readiness_report.csv", logic_readiness_2516 is not None)
_add_artifact_row_2516("data_contract_summary.json", section2_reports_dir_2516 / "data_contract_summary.json", data_contract_summary_2516 is not None)
_add_artifact_row_2516("data_integrity_index.csv", section2_reports_dir_2516 / "data_integrity_index.csv", integrity_index_2516 is not None)
_add_artifact_row_2516("data_drift_metrics.csv", section2_reports_dir_2516 / "data_drift_metrics.csv", numeric_drift_2516 is not None)
_add_artifact_row_2516("rare_category_report.csv", section2_reports_dir_2516 / "rare_category_report.csv", rare_cat_2516 is not None)

artifact_status_df_2516 = pd.DataFrame(artifact_status_rows_2516)

html_parts_2516.append('<div class="section-block">')
html_parts_2516.append("<h2>Artifact coverage (Section 2 core inputs)</h2>")
html_parts_2516.append(
    artifact_status_df_2516.to_html(index=False, escape=False)
)
html_parts_2516.append("</div>")

# -------------------------------------------------------------------------
# 4A) INTEGRITY_INDEX config preview
# -------------------------------------------------------------------------
cfg_rows_2516 = []

for k, v in integrity_weights_2516.items():
    cfg_rows_2516.append({"key": f"WEIGHTS.{k}", "value": v})

for k, v in contract_penalties_cfg_2516.items():
    cfg_rows_2516.append({"key": f"CONTRACT_PENALTIES.{k}", "value": v})

if cfg_rows_2516:
    cfg_view_2516 = pd.DataFrame(cfg_rows_2516)
    html_parts_2516.append('<div class="section-block">')
    html_parts_2516.append("<h2>Integrity index configuration (INTEGRITY_INDEX)</h2>")
    html_parts_2516.append(cfg_view_2516.to_html(index=False, escape=False))
    html_parts_2516.append("</div>")

# INTEGRITY_INDEX config preview
# html_parts_2516.append('<div class="section-block">')
# html_parts_2516.append("<h2>Integrity index configuration (INTEGRITY_INDEX)</h2>")
# cfg_view_2516 = pd.DataFrame([
#     {"key": f"WEIGHTS.{k}", "value": v} for k, v in integrity_weights_2516.items()
# ] + [
#     {"key": f"CONTRACT_PENALTIES.{k}", "value": v} for k, v in contract_penalties_cfg_2516.items()
# ])
# html_parts_2516.append(cfg_view_2516.to_html(index=False, escape=False))
# html_parts_2516.append("</div>")

# -------------------------------------------------------------------------
# 5) Optional: small tables from key artifacts
# -------------------------------------------------------------------------
# Model readiness table (top 20)
if model_readiness_2516 is not None:
    _mr_preview_2516 = model_readiness_2516.head(20).copy()
    html_parts_2516.append('<div class="section-block">')
    html_parts_2516.append("<h2>Model readiness (top 20 features)</h2>")
    html_parts_2516.append(_mr_preview_2516.to_html(index=False, escape=False))
    html_parts_2516.append("</div>")

# Logic readiness table (top 20)
if logic_readiness_2516 is not None:
    _lr_preview_2516 = logic_readiness_2516.head(20).copy()
    html_parts_2516.append('<div class="section-block">')
    html_parts_2516.append("<h2>Logic readiness (top 20 features)</h2>")
    html_parts_2516.append(_lr_preview_2516.to_html(index=False, escape=False))
    html_parts_2516.append("</div>")

# Data contract breakdown table
if isinstance(data_contract_summary_2516, dict) and "contracts" in data_contract_summary_2516:
    _contracts_df_2516 = pd.DataFrame(data_contract_summary_2516.get("contracts", []))
    if not _contracts_df_2516.empty:
        html_parts_2516.append('<div class="section-block">')
        html_parts_2516.append("<h2>Data contracts</h2>")
        _cols_2516 = [c for c in _contracts_df_2516.columns if c not in {"thresholds", "artifact"}] + \
                     [c for c in ["artifact"] if c in _contracts_df_2516.columns]
        html_parts_2516.append(_contracts_df_2516[_cols_2516].head(50).to_html(index=False, escape=False))
        html_parts_2516.append("</div>")

# Section 2 summary preview
if section2_summary_2516 is not None:
    html_parts_2516.append('<div class="section-block">')
    html_parts_2516.append("<h2>Section 2 summary (preview)</h2>")
    html_parts_2516.append(section2_summary_2516.head(40).to_html(index=False, escape=False))
    html_parts_2516.append("</div>")


# -------------------------------------------------------------------------
# 5B) Aggregate top logic issues from rule/group reports (2.5.7‚Äì2.5.9)
# -------------------------------------------------------------------------
logic_issue_rows_2516 = []

# 2.5.7 ‚Äì Categorical‚Äìnumeric alignment
try:
    _catnum_path_2516 = section2_reports_dir_2516 / "catnum_alignment_report.csv"
    if _catnum_path_2516.exists():
        _catnum_df_2516 = pd.read_csv(_catnum_path_2516)
        if not _catnum_df_2516.empty:
            _tmp_2516 = _catnum_df_2516.copy()
            _tmp_2516["source_section"] = "2.5.7"
            _tmp_2516["entity_id"] = _tmp_2516["rule_id"].astype(str)
            _tmp_2516["entity_type"] = "rule"
            _tmp_2516["severity"] = _tmp_2516.get("rule_severity", "info").astype(str)
            _tmp_2516["description"] = (
                "catnum alignment: "
                + _tmp_2516.get("group_col", "").astype(str)
                + " ‚Üí "
                + _tmp_2516.get("numeric_col", "").astype(str)
            )
            logic_issue_rows_2516.append(
                _tmp_2516[
                    [
                        "source_section",
                        "entity_type",
                        "entity_id",
                        "severity",
                        "description",
                        "violation_flag",
                        "violation_gap",
                        "notes",
                    ]
                ]
            )
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not pull catnum_alignment_report.csv into dashboard: {e}")

# 2.5.8 ‚Äì One-hot integrity
try:
    _onehot_path_2516 = section2_reports_dir_2516 / "onehot_integrity_report.csv"
    if _onehot_path_2516.exists():
        _onehot_df_2516 = pd.read_csv(_onehot_path_2516)
        if not _onehot_df_2516.empty:
            _tmp_2516 = _onehot_df_2516.copy()
            _tmp_2516["source_section"] = "2.5.8"
            _tmp_2516["entity_id"] = _tmp_2516["group_id"].astype(str)
            _tmp_2516["entity_type"] = "group"
            _tmp_2516["severity"] = _tmp_2516.get("group_severity", "info").astype(str)
            _tmp_2516["description"] = (
                "one-hot group: " + _tmp_2516.get("columns", "").astype(str)
            )
            # One-hot doesn‚Äôt have per-row flags; treat any non-OK as an ‚Äúissue‚Äù
            _tmp_2516["violation_flag"] = _tmp_2516["severity"].isin(["warn", "fail"])
            _tmp_2516["violation_gap"] = pd.NA
            _tmp_2516["notes"] = _tmp_2516.get("notes", "")
            logic_issue_rows_2516.append(
                _tmp_2516[
                    [
                        "source_section",
                        "entity_type",
                        "entity_id",
                        "severity",
                        "description",
                        "violation_flag",
                        "violation_gap",
                        "notes",
                    ]
                ]
            )
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not pull onehot_integrity_report.csv into dashboard: {e}")

# 2.5.9 ‚Äì Totals reconciliation
try:
    _totals_path_2516 = section2_reports_dir_2516 / "category_total_consistency.csv"
    if _totals_path_2516.exists():
        _totals_df_2516 = pd.read_csv(_totals_path_2516)
        if not _totals_df_2516.empty:
            _tmp_2516 = _totals_df_2516.copy()
            _tmp_2516["source_section"] = "2.5.9"
            _tmp_2516["entity_id"] = _tmp_2516["rule_id"].astype(str)
            _tmp_2516["entity_type"] = "rule"
            _tmp_2516["severity"] = _tmp_2516.get("rule_severity", "info").astype(str)
            _tmp_2516["description"] = (
                "totals vs components: "
                + _tmp_2516.get("total_col", "").astype(str)
            )
            _tmp_2516["violation_flag"] = _tmp_2516["severity"].isin(["warn", "fail"])
            _tmp_2516["violation_gap"] = _tmp_2516.get("max_abs_diff", pd.NA)
            _tmp_2516["notes"] = _tmp_2516.get("notes", "")
            logic_issue_rows_2516.append(
                _tmp_2516[
                    [
                        "source_section",
                        "entity_type",
                        "entity_id",
                        "severity",
                        "description",
                        "violation_flag",
                        "violation_gap",
                        "notes",
                    ]
                ]
            )
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not pull category_total_consistency.csv into dashboard: {e}")

logic_issues_2516 = (
    pd.concat(logic_issue_rows_2516, ignore_index=True)
    if logic_issue_rows_2516
    else pd.DataFrame(
        columns=[
            "source_section",
            "entity_type",
            "entity_id",
            "severity",
            "description",
            "violation_flag",
            "violation_gap",
            "notes",
        ]
    )
)

if not logic_issues_2516.empty:
    # Focus on WARN / FAIL and show top 30
    _mask_problem_2516 = logic_issues_2516["severity"].str.lower().isin(["warn", "fail"])
    _issues_view_2516 = logic_issues_2516.loc[_mask_problem_2516].copy()
    if _issues_view_2516.empty:
        _issues_view_2516 = logic_issues_2516.copy()

    html_parts_2516.append('<div class="section-block">')
    html_parts_2516.append("<h2>Top logic issues across 2.5.7‚Äì2.5.9</h2>")
    html_parts_2516.append(
        _issues_view_2516.head(30)[
            [
                "source_section",
                "entity_type",
                "entity_id",
                "severity",
                "description",
                "violation_flag",
                "violation_gap",
                "notes",
            ]
        ].to_html(index=False, escape=False)
    )
    html_parts_2516.append("</div>")

# -------------------------------------------------------------------------
# 5C) Integrity index history (last 10 runs)
# -------------------------------------------------------------------------
if integrity_history_2516 is not None and not integrity_history_2516.empty:
    _hist_2516 = integrity_history_2516.copy()

    # Best-effort parse / sort by timestamp
    if "timestamp_utc" in _hist_2516.columns:
        _hist_2516["timestamp_utc"] = pd.to_datetime(_hist_2516["timestamp_utc"], errors="coerce")
        _hist_2516 = _hist_2516.sort_values("timestamp_utc")
    elif "timestamp" in _hist_2516.columns:
        _hist_2516["timestamp"] = pd.to_datetime(_hist_2516["timestamp"], errors="coerce")
        _hist_2516 = _hist_2516.sort_values("timestamp")
    # Fallback: no sort

    # Compute delta vs previous run (if possible)
    if "integrity_index" in _hist_2516.columns:
        _hist_2516["integrity_delta"] = _hist_2516["integrity_index"].diff()

    html_parts_2516.append('<div class="section-block">')
    html_parts_2516.append("<h2>Integrity index history (last 10 runs)</h2>")
    cols_hist_2516 = [c for c in ["timestamp_utc", "timestamp", "run_id", "integrity_index", "integrity_delta", "contract_status"] if c in _hist_2516.columns]
    html_parts_2516.append(_hist_2516[cols_hist_2516].tail(10).to_html(index=False, float_format="%.2f"))
    html_parts_2516.append("</div>")


# FOOTER
html_parts_2516.append("""
</body>
</html>
""")

# -------------------------------------------------------------------------
# 6) Write dashboard HTML (atomic)
# -------------------------------------------------------------------------
_dashboard_written_2516 = False
try:
    with open(dashboard_tmp_2516, "w", encoding="utf-8") as f:
        f.write("".join(html_parts_2516))
    os.replace(dashboard_tmp_2516, dashboard_path_2516)
    _dashboard_written_2516 = True
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not write logic_integrity_dashboard.html: {e}")
    if dashboard_tmp_2516.exists():
        dashboard_tmp_2516.unlink(missing_ok=True)

# -------------------------------------------------------------------------
# 7) Unified diagnostics row (2.5.16)
# -------------------------------------------------------------------------
if section2_summary_2516 is not None:
    _existing_rows_2516 = int(len(section2_summary_2516))
else:
    _existing_rows_2516 = 0

n_panels_rendered_2516 = 0
if model_readiness_2516 is not None:
    n_panels_rendered_2516 += 1
if logic_readiness_2516 is not None:
    n_panels_rendered_2516 += 1
if data_contract_summary_2516 is not None:
    n_panels_rendered_2516 += 1
if section2_summary_2516 is not None:
    n_panels_rendered_2516 += 1

status_2516 = "OK" if _dashboard_written_2516 else "WARN"

summary_2516 = pd.DataFrame([{
    "section": "2.5.16",
    "section_name": "Logic consistency dashboard",
    "check": "Visualize integrity metrics across 2.3‚Äì2.5",
    "level": "info",
    "status": status_2516,
    "n_panels_rendered": int(n_panels_rendered_2516),
    "detail": "logic_integrity_dashboard.html",
    "timestamp": pd.Timestamp.utcnow(),
}])

append_sec2(summary_2516, SECTION2_REPORT_PATH)

# 2.5.16 ‚Äì Console UX summary
print("   ‚îÄ‚îÄ 2.5.16 dashboard KPIs (best-effort) ‚îÄ‚îÄ")
print(f"   ‚Ä¢ Integrity index (latest): "
      f"{integrity_index_2516:.1f}" if integrity_index_2516 is not None else "   ‚Ä¢ Integrity index (latest): ‚Äî")
print(f"   ‚Ä¢ Data contract status: {overall_contract_status_2516 or 'N/A'}")
print("   ‚Ä¢ Features high model readiness:",
      f"{pct_features_high_readiness_2516:.1f}%" if pct_features_high_readiness_2516 is not None else "‚Äî")
print("   ‚Ä¢ Features high logic readiness:",
      f"{pct_features_high_logic_2516:.1f}%" if pct_features_high_logic_2516 is not None else "‚Äî")

if pct_rows_logic_clean_2516 is not None:
    _val = pct_rows_logic_clean_2516
    if _val <= 1.0:
        _val *= 100.0
    print(f"   ‚Ä¢ Rows logic-clean (2.5.12): {_val:.1f}%")
else:
    print("   ‚Ä¢ Rows logic-clean (2.5.12): ‚Äî")

print("   ‚Ä¢ Numeric features with drift:",
      n_drifted_features_2516 if n_drifted_features_2516 is not None else "‚Äî")
print("   ‚Ä¢ Rare categories detected:",
      n_rare_categories_2516 if n_rare_categories_2516 is not None else "‚Äî")
if not _dashboard_written_2516:
    print("   ‚ö†Ô∏è Dashboard write failed; see warnings above.")

display(summary_2516)

2.5.16 üé® Logic consistency dashboard
   ‚ö†Ô∏è Could not read model_readiness_report.csv: name 'section2_reports_dir_2516' is not defined
   ‚ö†Ô∏è Could not read logic_readiness_report.csv: name 'section2_reports_dir_2516' is not defined
   ‚ö†Ô∏è Could not read data_contract_summary.json: name 'section2_reports_dir_2516' is not defined
   ‚ö†Ô∏è Could not read data_integrity_index.csv: name 'section2_reports_dir_2516' is not defined
   ‚ö†Ô∏è Could not read full integrity history: name 'section2_reports_dir_2516' is not defined
   ‚ö†Ô∏è Could not read data_drift_metrics.csv: name 'section2_reports_dir_2516' is not defined
   ‚ö†Ô∏è Could not read rare_category_report.csv: name 'section2_reports_dir_2516' is not defined
/var/folders/dn/wtcqyjbd1hn63s40771sdddm0000gn/T/ipykernel_87901/2687321414.py:147: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  _now_iso_2516 = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
Cell In[1289], line 295
    285 def _add_artifact_row_2516(name, path_obj, loaded_flag):
    286     artifact_status_rows_2516.append(
    287         {
    288             "artifact_name": name,
   (...)    292         }
    293     )
--> 295 _add_artifact_row_2516("section2_summary.csv", _sec2_summary_path_2516, section2_summary_2516 is not None)
    296 _add_artifact_row_2516("model_readiness_report.csv", section2_reports_dir_2516 / "model_readiness_report.csv", model_readiness_2516 is not None)
    297 _add_artifact_row_2516("logic_readiness_report.csv", section2_reports_dir_2516 / "logic_readiness_report.csv", logic_readiness_2516 is not None)

NameError: name '_sec2_summary_path_2516' is not defined
```

># A:
It‚Äôs happening **now** because 2.5.16 is the first place you‚Äôve pasted code that assumes a bunch of ‚Äúsetup locals‚Äù exist (`section2_reports_dir_2516`, `_sec2_summary_path_2516`, `dashboard_tmp_2516`, `dashboard_path_2516`, etc.) **but you never created them in this cell** and they‚Äôre **not part of your bootstrap truth** (`SEC2_REPORTS_DIR`, `SEC2_REPORT_DIRS`, `SECTION2_REPORT_PATH`, etc.).

Earlier cells ‚Äúworked‚Äù either because:

* they happened to use only bootstrap globals, **or**
* you had a similarly-named local defined in the same cell (e.g., `section2_reports_dir_2511`), **or**
* you executed cells in an order where an old local was still hanging around in the kernel.

When you restarted / ran out-of-order / edited, those locals disappeared, so now you get NameErrors.

‚úÖ **Best fix:** make every ‚ÄúPart‚Äù cell define a tiny **cell-local anchor block** at the top that derives everything from your bootstrap globals. No functions needed.

---

## Minimal ‚Äúanchors‚Äù block for 2.5.16 (paste at the top)

This fixes **both** `section2_reports_dir_2516` and `_sec2_summary_path_2516` and the dashboard output paths.

```python
# --- 2.5.16 anchors (no functions; derive from bootstrap globals)

from pathlib import Path
from datetime import datetime, timezone

assert "SEC2_REPORTS_DIR" in globals() and SEC2_REPORTS_DIR, "Run 2.0 Part 5+ (SEC2_REPORTS_DIR) first."
assert "SEC2_REPORT_DIRS" in globals() and isinstance(SEC2_REPORT_DIRS, dict), "Run 2.0 Part 6 (SEC2_REPORT_DIRS) first."
assert "SECTION2_REPORT_PATH" in globals() and SECTION2_REPORT_PATH, "Run 2.0 Part 7 (SECTION2_REPORT_PATH) first."

# Canonical report dir to read/write ‚Äúshared‚Äù Section 2 report artifacts
section2_reports_dir_2516 = Path(SEC2_REPORTS_DIR).resolve()
section2_reports_dir_2516.mkdir(parents=True, exist_ok=True)

# Canonical chapter dir for 2.5 outputs (optional but nice)
sec25_reports_dir_2516 = Path(SEC2_REPORT_DIRS["2.5"]).resolve()
sec25_reports_dir_2516.mkdir(parents=True, exist_ok=True)

# Section 2 unified report (csv) path
_sec2_summary_path_2516 = Path(SECTION2_REPORT_PATH).resolve()

# Dashboard output path (write into 2.5 chapter dir OR section2 root‚Äîpick one)
dashboard_path_2516 = (sec25_reports_dir_2516 / "logic_integrity_dashboard.html").resolve()
dashboard_tmp_2516  = dashboard_path_2516.with_suffix(".tmp.html")

_now_iso_2516 = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
```

### Then change **all** your reads like this:

Replace:

```python
_mr_path_2516 = section2_reports_dir_2516 / "model_readiness_report.csv"
```

‚úÖ Keep that line (it will now work).

And for the ‚Äúsection2_summary_2516‚Äù piece, you currently never load it. Add this near the top:

```python
section2_summary_2516 = None
try:
    if _sec2_summary_path_2516.exists():
        section2_summary_2516 = pd.read_csv(_sec2_summary_path_2516)
except Exception as e:
    print(f"   ‚ö†Ô∏è Could not read SECTION2_REPORT_PATH: {e}")
```

---

## Also: remove the accidental function def if you truly mean ‚Äúno functions‚Äù

You currently define:

```python
def _add_artifact_row_2516(...)
```

If ‚Äúno functions‚Äù is a rule for this notebook section, do it inline:

```python
artifact_status_rows_2516 = []

artifact_status_rows_2516.append({
    "artifact_name": "section2_summary.csv",
    "path": str(_sec2_summary_path_2516),
    "exists_on_disk": bool(_sec2_summary_path_2516.exists()),
    "loaded_in_dashboard": bool(section2_summary_2516 is not None),
})
```

‚Ä¶and repeat for each artifact.

---

## Why this is the *best* pattern for you

* Uses **only bootstrap truth**: `SEC2_REPORTS_DIR`, `SEC2_REPORT_DIRS`, `SECTION2_REPORT_PATH`
* Makes the cell **independently runnable** (aka *re-entrant* / *idempotent-ish*)
* Stops the ‚Äúworked yesterday, fails today‚Äù kernel-order problem

üí°üí° If you want to make this super consistent: do a 3‚Äì10 line ‚ÄúANCHORS‚Äù block at the top of **every** 2.5.xx cell:

* resolve `sec25_reports_dir_<id>`
* resolve `section2_reports_dir_<id>`
* resolve any output file paths
* never rely on `section2_reports_dir_XXXX` existing from another cell

If you paste your intended ‚Äúwhere should dashboard live‚Äù policy (2.5 dir vs section2 root), I‚Äôll rewrite your 2.5.16 header block to follow it exactly.
