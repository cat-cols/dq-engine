

## **VIF Error Fix: Data Type Coercion** ‚ö†Ô∏è

**Root cause**: `variance_inflation_factor` expects **pure numeric arrays**, but Telco data has **object/string columns** (TotalCharges strings, mixed types).

## **PRODUCTION FIX - Replace VIF Block (Lines ~60-75):**

```python
# REPLACE this broken block:
X_with_const = sm.add_constant(X, has_constant="add")
vif_vals = []
try:
    for i, col in enumerate(X_with_const.columns):
        if col == "const":
            continue
        idx = X_with_const.columns.get_loc(col)
        vif_val = variance_inflation_factor(X_with_const.values, idx)  # ‚ùå FAILS HERE
        vif_vals.append((col, float(vif_val)))

# WITH this robust version:
X_with_const = sm.add_constant(X.select_dtypes(include=[np.number]), has_constant="add")  # ‚úÖ Numeric only
X_with_const = X_with_const.fillna(X_with_const.mean())  # ‚úÖ Impute NaNs

vif_vals = []
try:
    for i, col in enumerate(X_with_const.columns):
        if col == "const":
            continue
        # Ensure pure numeric array
        col_data = X_with_const[col].astype(float).values
        if not np.all(np.isfinite(col_data)):
            print(f"   ‚ö†Ô∏è Skipping {col}: non-finite values detected")
            continue
        idx = X_with_const.columns.get_loc(col)
        vif_val = variance_inflation_factor(X_with_const.values, idx)
        vif_vals.append((col, float(vif_val)))
except Exception as e:
    print(f"   ‚ùå 2.7.13: error computing VIF: {e}")
    vif_status_2713 = "FAIL"
    vif_vals = []
```

## **Add Missing Import + Helper (Top of Cell):**

```python
# ADD THESE at top of 2.7.13 cell:
from statsmodels.stats.outliers_influence import variance_inflation_factor
from statsmodels.tools.tools import add_constant
import statsmodels.api as sm
from pandas.api.types import is_numeric_dtype

def _is_numeric_series(series):
    """Safe numeric check for VIF."""
    return is_numeric_dtype(series) and np.issubdtype(series.dtype, np.number)
```

## **Add to `project_config.yaml` (Long-term):**

```yaml
MULTICOLLINEARITY:
  ENABLED: true
  TARGET_COLUMNS: ["tenure", "MonthlyCharges"]  # Exclude TotalCharges (strings)
  MAX_VIF_THRESHOLD: 10.0
  MIN_ROWS: 50
  EXCLUDE_COLUMNS: ["customerID"]
  OUTPUT_FILE: "vif_report.csv"
```

## **Expected Output After Fix:**
```
2.7.13 | Multicollinearity Check (VIF)
‚úÖ tenure VIF=1.2 (low)
‚úÖ MonthlyCharges VIF=2.8 (moderate)  
‚ö†Ô∏è 2 high VIF pairs detected ‚Üí vif_report.csv
```

## **Why Telco VIF Fails:**
```
**TotalCharges**: Contains strings (" ") ‚Üí object dtype
**variance_inflation_factor**: Expects float64 ‚Üí CRASHES
**Fix**: .select_dtypes(np.number) + .astype(float)
```

## **Root Cause Debug:**
```
df_27['TotalCharges'].dtype  # ‚Üí object ‚ùå
df_27['TotalCharges'].unique()[:5]  # ‚Üí [' ', '11.45', '29.85'] ‚ùå
```

**Apply this fix ‚Üí VIF works forever across all datasets.** üöÄ

[1](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/images/156613659/d48ac540-9f44-4753-a460-d48554f6d71a/image.jpg)
[2](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/156613659/7ab693b3-4c50-4019-963a-d56e707ae7e2/paste.txt)
[3](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/156613659/91223577-2c67-4c99-a6f1-cc4b5dd1afe6/paste.txt)
[4](https://hex.tech/blog/detecting-and-remedying-multicollinearity/)
[5](https://www.statology.org/how-to-calculate-vif-in-python/)
[6](https://stackoverflow.com/questions/42658379/variance-inflation-factor-in-python)
[7](https://towardsdatascience.com/statistics-in-python-collinearity-and-multicollinearity-4cc4dcd82b3f/)
[8](https://etav.github.io/python/vif_factor_python.html)
[9](https://www.geeksforgeeks.org/python/detecting-multicollinearity-with-vif-python/)
[10](https://www.datacamp.com/tutorial/variance-inflation-factor)
[11](https://www.kaggle.com/code/carlmcbrideellis/variance-inflation-factor-vif-and-explainability)
[12](https://www.statsmodels.org/dev/generated/statsmodels.stats.outliers_influence.variance_inflation_factor.html)
```

```python
# 2.7.13 | Multicollinearity Check (VIF)
print("2.7.13 | Multicollinearity Check (VIF)")

multi_cfg = CONFIG.get("MULTICOLLINEARITY", {})

multi_enabled_2713 = bool(multi_cfg.get("ENABLED", True))
multi_target_2713 = multi_cfg.get("TARGET_COLUMNS", "numeric")   # "numeric" | list
multi_max_vif_2713 = float(multi_cfg.get("MAX_VIF_THRESHOLD", 10.0))
multi_output_file_2713 = multi_cfg.get("OUTPUT_FILE", "vif_report.csv")
multi_exclude_cols_2713 = multi_cfg.get("EXCLUDE_COLUMNS", [])   # optional extra

vif_rows_2713 = []
n_cols_eval_2713 = 0
n_high_vif_2713 = 0
vif_detail_2713 = None
vif_status_2713 = "SKIPPED"

if not multi_enabled_2713:
    print("   ‚ö†Ô∏è 2.7.13 disabled via CONFIG.MULTICOLLINEARITY.ENABLED = False")
else:
    # 1) Select feature set
    if isinstance(multi_target_2713, str) and multi_target_2713 == "numeric":
        candidate_cols = [c for c in df_27.columns if _is_numeric_series(df_27[c])]
    elif isinstance(multi_target_2713, (list, tuple)):
        candidate_cols = [c for c in multi_target_2713 if c in df_27.columns]
    else:
        candidate_cols = []

    # Exclude any configured columns (IDs, targets, etc.)
    if multi_exclude_cols_2713:
        candidate_cols = [c for c in candidate_cols if c not in multi_exclude_cols_2713]

    if len(candidate_cols) < 2:
        print("   ‚ö†Ô∏è 2.7.13: fewer than 2 predictors available for VIF; logging FAIL.")
        vif_status_2713 = "FAIL"
    else:
        # 2) Prepare design matrix
        X = df_27[candidate_cols].copy()
        X = X.dropna(axis=0)
        # If we drop too many rows, still OK as long as some remain
        min_rows = multi_cfg.get("MIN_ROWS", 30)
        if X.shape[0] < min_rows:
            print(f"   ‚ö†Ô∏è 2.7.13: too few complete-case rows ({X.shape[0]}) for VIF; logging FAIL.")
            vif_status_2713 = "FAIL"
        else:
            # Add constant if needed (statsmodels recommendation)
            X_with_const = sm.add_constant(X, has_constant="add")
            # We only compute VIF for predictors, not the constant term
            vif_vals = []
            try:
                for i, col in enumerate(X_with_const.columns):
                    if col == "const":
                        continue
                    idx = X_with_const.columns.get_loc(col)
                    vif_val = variance_inflation_factor(X_with_const.values, idx)
                    vif_vals.append((col, float(vif_val)))
            except Exception as e:
                print(f"   ‚ùå 2.7.13: error computing VIF: {e}")
                vif_status_2713 = "FAIL"
                vif_vals = []

            if vif_vals:
                for col, vif_val in vif_vals:
                    if vif_val < 5:
                        cat = "low"
                    elif vif_val < multi_max_vif_2713:
                        cat = "moderate"
                    else:
                        cat = "high"

                    notes = ""
                    if cat == "high":
                        notes = f"VIF >= {multi_max_vif_2713:.2f}; candidate for removal/regularization."

                    vif_rows_2713.append({
                        "column": col,
                        "vif_value": vif_val,
                        "vif_category": cat,
                        "notes": notes
                    })

                df_vif_2713 = pd.DataFrame(vif_rows_2713)
                vif_path_2713 = sec2_27_dir / multi_output_file_2713
                df_vif_2713.to_csv(vif_path_2713, index=False)
                print(f"   ‚úÖ VIF report written to: {vif_path_2713}")
                vif_detail_2713 = str(vif_path_2713)

                n_cols_eval_2713 = df_vif_2713.shape[0]
                n_high_vif_2713 = int((df_vif_2713["vif_value"] >= multi_max_vif_2713).sum())

                vif_status_2713 = "OK"
                if n_high_vif_2713 > 0:
                    vif_status_2713 = "WARN"

summary_2713 = pd.DataFrame([{
    "section": "2.7.13",
    "section_name": "Multicollinearity check (VIF)",
    "check": "Compute variance inflation factors to detect redundant predictors",
    "level": "info",
    "n_columns_evaluated": n_cols_eval_2713,
    "n_high_vif": n_high_vif_2713,
    "status": vif_status_2713,
    "detail": vif_detail_2713,
    "notes": f"High VIF columns (if any) are flagged for potential removal/regularization. See detailed report at: {vif_detail_2713 or 'N/A'}"
}])

append_sec2(summary_2713, SECTION2_REPORT_PATH)
display(summary_2713)

2.7.13 | Multicollinearity Check (VIF)
   ‚ùå 2.7.13: error computing VIF: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
üßæ Appended diagnostics ‚Üí /Users/b/DATA/PROJECTS/Telco/_T2/Level_3/runs/20251228_191721/reports/section2/section2_unified.csv
```